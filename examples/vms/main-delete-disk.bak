data proxmox_qemu_image alma_base {
  name = "alma-base-image"
  storage_name = "vm-images"
}

data proxmox_vm test {
  node_name = "proxmox-01"
  vm_id = "110"
}

resource proxmox_vm test {
  name = "terraform-test-vm"
  qemu_agent_enabled = true
  cores = "2"
  memory = "4096"
  os_type = "l26"
  description = "terraform testing vm"
  node_name = "proxmox-03"
  vm_id = "9999"
  cpu_type = "host"
  boot_order = ["scsi0"]
  host_startup_order = 1
  protection = false
  nameserver = "10.1.0.8"
  start_on_boot = true
  default_user = "zevrant"
  cloud_init_storage_name = "exosDisks"
  power_state = "stopped"
  ssh_keys = [
    "ecdsa-sha2-nistp384 AAAAE2VjZHNhLXNoYTItbmlzdHAzODQAAAAIbmlzdHAzODQAAABhBLtOxtriPtNmisKkmfHfCByaTYCHRsDHyzQAi0yL6LUeKybjYExfR6N0xBMcIj6M/b5U3aafjKayX4nMvV7s7/vcrpBfW+WvxOCBWTlhKGNpUmAS9ApFDn51/FTuRgB/YA=="
  ]
  ip_config {
    ip_address = "10.1.0.100/24"
    gateway = "10.1.0.1"
    order = 0
  }

  disk {
    bus_type = "scsi"
    storage_location = "local-zfs"
    size = "50G"
    order = 0
    import_from = data.proxmox_qemu_image.alma_base.storage_name
    //Must be preloaded at this location, full path is /var/lib/vz/images/0/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2
    //Long term recommendation is to use an nfs mount or something that supports RWM
    import_path = "import/${data.proxmox_qemu_image.alma_base.name}-${data.proxmox_qemu_image.alma_base.version}.qcow2"
  }

  disk {
    bus_type = "scsi"
    storage_location = "plex"
    size = "51G"
    order = 2
  }



  network_interface {
    mac_address = "1a:2b:3c:4e:5f:61"
    bridge = "shared"
    firewall = true
    order = 0
    mtu = 1412
  }


}
#
#
#
# check vm_agent_check {
#   data "http" "vm_agent_metrics" {
#     url = "http://${split("/", proxmox_vm.test.ip_config[0].ip_address)[0]}:9100/metrics"
#     request_timeout_ms = 1000
#     retry {
#       attempts = 5
#       min_delay_ms = 5000
#       max_delay_ms = 10000
#     }
#
#     depends_on = []
#   }
#   assert {
#     condition = data.http.vm_agent_metrics.status_code == 200
#     error_message = "Vm metrics could not be retrieved, is node exporter running?"
#   }
#   assert {
#     condition = strcontains(data.http.vm_agent_metrics.response_body, "node_systemd_unit_state")
#     error_message = "The target VM does not have the systemd collector enabled, status could not be checked"
#   }
#   assert {
#     condition = strcontains(data.http.vm_agent_metrics.response_body, "zs-vm-agent")
#     error_message = "The VM configuration agent couldn't be reached please check system configuration and logs"
#   }
# }